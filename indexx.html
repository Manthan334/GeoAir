<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>PolluMap â€“ Fire & Pollution Dashboard (Zonal + Alerts)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100%; }

    #sidebar {
      position: absolute; top: 10px; left: 10px; width: 280px;
      background: #fff; padding: 12px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,.2); z-index: 1001;
    }
    #sidebar h3 { margin: 4px 0 8px; font-size: 18px; }
    button { padding: 6px 10px; border-radius: 6px; border: none;
      cursor: pointer; background: #1976d2; color: #fff; margin-top: 5px; }
    button.danger { background: #d32f2f; }
    button.secondary { background: #6b6b6b; }

    .alert-banner {
      position: absolute; top: 10px; right: 10px; z-index: 1002;
      background: #ffeb3b; padding: 10px 14px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,.2); display: none;
    }

    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.45); z-index: 2000; }
    .modal .card { background: #fff; padding: 18px; border-radius: 10px; width: 320px;
      box-shadow: 0 6px 18px rgba(0,0,0,.3); }

    .pulse-marker { width: 18px; height: 18px; border-radius: 50%;
      background: rgba(255,0,0,0.9); box-shadow: 0 0 10px 4px rgba(255,0,0,0.2);
      animation: pulse 1.2s infinite; }
    @keyframes pulse {
      0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(255,0,0,0.25); }
      70% { transform: scale(1.2); box-shadow: 0 0 0 12px rgba(255,0,0,0); }
      100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(255,0,0,0); }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div id="sidebar">
    <h3>PolluMap</h3>
    <p>ðŸ”¥ Active Fires (last 7 days)</p>
    <button id="toggleHeatmap">Toggle Heatmap</button>
    <button id="togglePoints" class="secondary">Toggle Points</button>
    <button id="zoomToHigh" class="danger">Zoom to High Risk</button>
  </div>

  <div id="alertBanner" class="alert-banner"></div>

  <div id="modal" class="modal">
    <div class="card">
      <h4 id="modalTitle"></h4>
      <p id="modalBody"></p>
      <div style="text-align:right; margin-top:8px;">
        <button id="modalClose">Close</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

  <script>
    const map = L.map('map').setView([20, 78], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: 'Â© OpenStreetMap' }).addTo(map);

    let firePointsLayer = L.layerGroup().addTo(map);
    let heatLayer;
    let highRiskMarkers = [];

    const HIGH_THRESHOLD = 0.8, MEDIUM_THRESHOLD = 0.5;

    function confidenceWeight(c) {
      if (!c) return 0.8;
      c = c.toLowerCase();
      if (c === "h") return 1;
      if (c === "n" || c === "nominal") return 0.9;
      if (c === "l") return 0.7;
      return 0.8;
    }

    function riskColor(s) {
      return s >= HIGH_THRESHOLD ? "#b71c1c" :
             (s >= MEDIUM_THRESHOLD ? "#ff9800" : "#4caf50");
    }

    function brightnessColor(b) {
      const min = 270, max = 370;
      const t = Math.max(0, Math.min(1, (b - min) / (max - min)));
      return `rgb(${Math.round(255*t)},${Math.round(200*(1-t))},${Math.round(50*(1-t))})`;
    }

    fetch("fires_last7days_clean.geojson")
      .then(r => r.json())
      .then(data => {
        const feats = data.features;
        const heatPts = feats.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0], 0.7]);
        heatLayer = L.heatLayer(heatPts, { radius: 25, blur: 18, maxZoom: 10 });

        feats.forEach(f => {
          const lat = f.geometry.coordinates[1], lon = f.geometry.coordinates[0];
          const br = f.properties.brightness || 300;
          const frp = +f.properties.frp || 0;
          const conf = f.properties.confidence || 'n';

          const frpNorm = Math.min(1, frp / 20);
          const confW = confidenceWeight(conf);
          const risk = Math.min(1, frpNorm * confW);

          const m = L.circleMarker([lat, lon], {
            radius: 5, fillColor: brightnessColor(br), color: "#fff", weight: 1, fillOpacity: 0.9
          });

          m.bindPopup(`
            <b>ðŸ”¥ Fire</b><br>
            Lat: ${lat.toFixed(3)} Lon: ${lon.toFixed(3)}<br>
            Brightness: ${br}<br>FRP: ${frp}<br>Conf: ${conf}<br>
            Risk: <span style="color:${riskColor(risk)}">${(risk*100).toFixed(0)}%</span>
            ${risk >= HIGH_THRESHOLD ? '<br><b style="color:red">High risk â€” wear mask!</b>' : ''}
          `);

          m.on("click", () => {
            if (risk >= HIGH_THRESHOLD) {
              triggerAlert(
                "High Fire Risk Nearby",
                `Detected ${(risk*100).toFixed(0)}% risk. Avoid outdoors, wear mask.`,
                [lat, lon]
              );
            }
          });

          firePointsLayer.addLayer(m);

          if (risk >= HIGH_THRESHOLD) {
            const pulser = L.divIcon({
              html: '<div class="pulse-marker"></div>',
              iconSize: [18, 18], iconAnchor: [9, 9]
            });
            highRiskMarkers.push(L.marker([lat, lon], { icon: pulser }));
          }
        });
      });

    document.getElementById("toggleHeatmap").onclick = () => {
      if (!heatLayer) return;
      map.hasLayer(heatLayer) ? map.removeLayer(heatLayer) : map.addLayer(heatLayer);
    };

    document.getElementById("togglePoints").onclick = () => {
      map.hasLayer(firePointsLayer) ? map.removeLayer(firePointsLayer) : map.addLayer(firePointsLayer);
    };

    document.getElementById("zoomToHigh").onclick = () => {
      if (highRiskMarkers.length === 0) return alert("No high-risk hotspots.");
      const g = L.featureGroup(highRiskMarkers).addTo(map);
      map.fitBounds(g.getBounds().pad(0.6));
      setTimeout(() => map.removeLayer(g), 2000);
    };

    function triggerAlert(title, body, latlng) {
      const banner = document.getElementById("alertBanner");
      banner.innerHTML = `<b>${title}</b><br><small>${body}</small>`;
      banner.style.display = "block";
      setTimeout(() => banner.style.display = "none", 10000);

      document.getElementById("modalTitle").innerText = title;
      document.getElementById("modalBody").innerText = body;
      document.getElementById("modal").style.display = "flex";

      if (latlng) {
        const pulser = L.divIcon({
          html: '<div class="pulse-marker"></div>',
          iconSize: [18, 18], iconAnchor: [9, 9]
        });
        const pm = L.marker(latlng, { icon: pulser }).addTo(map);
        setTimeout(() => map.removeLayer(pm), 60000);
      }
    }

    document.getElementById("modalClose").onclick = () => {
      document.getElementById("modal").style.display = "none";
    };
    document.getElementById("modal").onclick = e => {
      if (e.target.id === "modal") e.target.style.display = "none";
    };
  </script>
</body>
</html>
